<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libmicroemu: ARM Microcontroller Emulator Library</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">libmicroemu<span id="projectnumber">&#160;0.2.0</span>
   </div>
   <div id="projectbrief">ARM Microcontroller Emulator Library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="doc-content">
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">ARM Microcontroller Emulator Library </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md__r_e_a_d_m_e"></a></p>
<p><em>libmicroemu</em> is a lightweight, embeddable library for ARM microcontroller emulation, currently supporting the ARMv7-M architecture with plans to extend to additional ARM architectures. It is designed for:</p>
<ul>
<li><b>Accelerating development</b> by enabling local testing of ARM programs</li>
<li><b>Creating digital twins</b> for commissioning without physical hardware</li>
<li><b>Embedding ARM emulation</b> seamlessly into larger projects</li>
</ul>
<p>While shipped with a command-line application (called <em>microemu</em>), <em>libmicroemu</em> can be used independently, allowing for flexible integration.</p>
<p><a href="https://github.com/chgroeling/libmicroemu/releases"><img src="https://img.shields.io/github/v/release/chgroeling/libmicroemu?label=release&amp;sort=semver" alt="GitHub release (latest SemVer)" class="inline"/></a><a href="https://github.com/chgroeling/libmicroemu/actions/workflows/tests.yml"><img src="https://github.com/chgroeling/libmicroemu/actions/workflows/tests.yml/badge.svg" alt="tests" style="pointer-events: none;" class="inline"/></a><a href="https://chgroeling.github.io/libmicroemu"><img src="https://github.com/chgroeling/libmicroemu/actions/workflows/docs.yml/badge.svg" alt="docs" style="pointer-events: none;" class="inline"/></a><a href="https://opensource.org/licenses/MIT"><img src="https://img.shields.io/badge/License-MIT-yellow.svg" alt="License: MIT" style="pointer-events: none;" class="inline"/></a></p>
<h2><a class="anchor" id="autotoc_md1"></a>
Key Features</h2>
<ul>
<li><b>Dependency-Free Core</b> <br  />
 No external libraries are needed to use <em>libmicroemu</em>.</li>
<li><b>Embeddable Design</b> <br  />
 Integrate easily into any C++ project or use it as a standalone emulator.</li>
<li><b>Accurate ARM Cortex-M Simulation</b> <br  />
 Emulates ARMv7-M with full exception support (e.g., UsageFault, HardFault, SysTick). Future plans include ARMv7-A and support for the NVIC.</li>
<li><b>Predictable and Deterministic Behavior</b> <br  />
 The emulator ensures consistent execution by avoiding dynamic memory allocation and non-deterministic algorithms, making it suitable for applications requiring repeatable outcomes.</li>
<li><b>No C++ Exceptions</b> <br  />
 The emulator is implemented without the use of C++ exceptions, providing a predictable control flow and simplifying integration into projects that avoid exception handling.</li>
<li><b>Optional Command-Line Interface</b> <br  />
 The companion CLI program <em>microemu</em> simplifies testing and debugging. It requires Conan for managing dependencies (fmt, spdlog, cxxopts), while <em>libmicroemu</em> itself remains dependency-free.</li>
<li><b>Semihosting Support</b> <br  />
 Provides built-in semihosting, enabling communication between the emulator and the host system for tasks such as file I/O and console output.</li>
</ul>
<h1><a class="anchor" id="autotoc_md2"></a>
Development Status</h1>
<p><em>libmicroemu</em> is currently under active development and can already execute a significant range of ARMv7-M programs. Floating-point functionality is not natively supported in the emulator at this time, but it can be achieved by compiling programs with <code>-mfloat-abi=soft</code>, allowing software-based floating-point emulation within the binary itself.</p>
<h2><a class="anchor" id="autotoc_md3"></a>
Roadmap</h2>
<ul>
<li><b>ARM Core Completion</b> – Prioritize complete ARMv7-M functionality, then expand to other architectures like ARMv7-A.</li>
<li><b>Performance Optimization</b> – Implement performance optimizations after achieving full ARMv7-M support.</li>
<li><b>Peripheral Emulation Expansion</b> – Limited peripheral support initially, focused on ARM core compatibility.</li>
<li><b>NVIC Support</b> – Planned implementation for ARMv7-M interrupt controller.</li>
<li><b>Hardware Floating-Point Emulation</b> – Planned support for native floating-point instructions.</li>
<li><b>Remote Debugging Support</b> – Planned GDB integration for interactive debugging capabilities.</li>
<li><b>Broader Configuration Options</b> – Further flexibility for custom peripherals and memory configurations.</li>
<li><b>Vendor-Specific Chip Support</b> - Expand support for vendor-specific peripherals and features (e.g. STM and Renesas chips)</li>
<li><b>Doxygen Documentation Improvement</b> – Enhance Doxygen documentation to improve usability and clarity, adding detailed descriptions for modules, functions, and configuration options to assist developers and users.</li>
</ul>
<h1><a class="anchor" id="autotoc_md4"></a>
Getting Started</h1>
<h2><a class="anchor" id="autotoc_md5"></a>
Installation</h2>
<ol type="1">
<li><p class="startli"><b>Clone the Repository:</b> Clone the repository to your local machine and navigate into the project directory:</p>
<div class="fragment"><div class="line">git clone https://github.com/chgroeling/libmicroemu</div>
<div class="line">cd libmicroemu</div>
</div><!-- fragment --></li>
<li><p class="startli"><b>Install Dependencies:</b> <em>libmicroemu</em> uses Conan 2 for dependency management, with profiles for different machines stored in the ./profiles directory. While Conan is primarily needed for the <em>microemu</em> CLI, it also installs toolchains and GTest, making its use advisable. Run the following command to install dependencies and set options for building standalone components:</p>
<div class="fragment"><div class="line">conan install . -pr ./profiles/&lt;your_build_profile&gt; -o build_tests=True -o build_microemu=True --build=missing</div>
</div><!-- fragment --><p class="startli">Replace &lt;your_build_profile&gt; with the appropriate profile names for your setup. This version uses the conan -o option for enabling <em>build_tests</em> and <em>build_microemu</em> when installing dependencies.</p>
</li>
<li><p class="startli"><b>Build the Project with CMake:</b> Create a build directory, configure the project, and compile it:</p>
<div class="fragment"><div class="line">cd build &amp;&amp; cd Debug</div>
<div class="line">cmake .</div>
<div class="line">cmake --build .</div>
</div><!-- fragment --></li>
<li><p class="startli"><b>Run the Tests:</b> To verify that everything is set up correctly, run the tests:</p>
<div class="fragment"><div class="line">ctest</div>
</div><!-- fragment --></li>
</ol>
<h2><a class="anchor" id="autotoc_md6"></a>
Running the Emulator</h2>
<p>With the build complete, you can run ARM binaries using <em>microemu</em>:</p>
<div class="fragment"><div class="line">./microemu path/to/your-binary.elf</div>
</div><!-- fragment --><p>The application provides logs showing register states, memory operations, and decoded instructions to assist with debugging. Use the "--help" command line option to learn more.</p>
<h2><a class="anchor" id="autotoc_md7"></a>
Precompiled Libraries and Releases</h2>
<p><em>libmicroemu</em> includes precompiled libraries in its releases, tagged using semantic versioning (e.g., <code>v1.0.0</code>). These binaries simplify integration and reduce build time, allowing for quick use without the need for compiling from source. Available on the <a href="https://github.com/chgroeling/libmicroemu/releases">GitHub releases page</a>, they include platform-specific static libraries and the <em>microemu</em> CLI program. For custom needs, building from source remains an option to meet specific configuration requirements.</p>
<h1><a class="anchor" id="autotoc_md8"></a>
Embedding libmicroemu in Your Project</h1>
<p><em>libmicroemu</em> is designed to be easily integrated into larger C++ projects to provide ARM emulation capabilities. Below is a basic example demonstrating how to set up and execute an ELF binary using the library.</p>
<h2><a class="anchor" id="autotoc_md9"></a>
Example: Integrating libmicroemu</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="machine_8h.html">libmicroemu/machine.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;vector&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Path to the ELF file</span></div>
<div class="line"><span class="keyword">constexpr</span> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *kElfPath = <span class="stringliteral">&quot;coremark/prebuilt/bin/coremark.elf&quot;</span>;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">constexpr</span> <span class="keyword">static</span> libmicroemu::me_adr_t kFlashSegVadr = 0x0U;</div>
<div class="line"><span class="keyword">constexpr</span> <span class="keyword">static</span> libmicroemu::me_adr_t kRam1SegVadr = 0x20000000U;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main() {</div>
<div class="line">  <a class="code hl_class" href="classlibmicroemu_1_1_machine.html">libmicroemu::Machine</a> machine;</div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;Using libmicroemu version: &quot;</span> &lt;&lt; machine.<a class="code hl_function" href="classlibmicroemu_1_1_machine.html#a41d9ccc5599dde9f3f214135a66aae9b">GetVersion</a>() &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Allocate memory for FLASH and RAM1 segments</span></div>
<div class="line">  <span class="keyword">auto</span> flash_seg = std::vector&lt;uint8_t&gt;(0x20000u); <span class="comment">// 128KB for FLASH</span></div>
<div class="line">  <span class="keyword">auto</span> ram1_seg = std::vector&lt;uint8_t&gt;(0x40000u);  <span class="comment">// 256KB for RAM1</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Set up memory segments</span></div>
<div class="line">  machine.<a class="code hl_function" href="classlibmicroemu_1_1_machine.html#ae157cfa801f766a3641e02ad801e6aeb">SetFlashSegment</a>(flash_seg.data(), flash_seg.size(), kFlashSegVadr);</div>
<div class="line">  machine.<a class="code hl_function" href="classlibmicroemu_1_1_machine.html#ad21e56744fbf8b9e17f84fc8c176341a">SetRam1Segment</a>(ram1_seg.data(), ram1_seg.size(), kRam1SegVadr);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Load the ELF file and set the entry point</span></div>
<div class="line">  <span class="keywordflow">if</span> (machine.<a class="code hl_function" href="classlibmicroemu_1_1_machine.html#af2b65fd6dcefc96f69974afb3b4ee66e">Load</a>(kElfPath, <span class="keyword">true</span>) != <a class="code hl_enumvalue" href="namespacelibmicroemu.html#a8986ac92210d741de2fbcbaf489c0ee0a8c632159fa131f09d04f94e3cbcd8782">libmicroemu::StatusCode::kSuccess</a>) {</div>
<div class="line">    std::cerr &lt;&lt; <span class="stringliteral">&quot;Failed to load ELF file.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">    <span class="keywordflow">return</span> EXIT_FAILURE;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Execute the ELF file</span></div>
<div class="line">  <span class="keyword">auto</span> res_exec = machine.<a class="code hl_function" href="classlibmicroemu_1_1_machine.html#a7f302218280c95778710a790296b9514">Exec</a>();</div>
<div class="line">  <span class="keywordflow">if</span> (res_exec.IsErr()) {</div>
<div class="line">    std::cerr &lt;&lt; <span class="stringliteral">&quot;Failed to execute ELF file.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">    <span class="keywordflow">return</span> EXIT_FAILURE;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="aclasslibmicroemu_1_1_machine_html"><div class="ttname"><a href="classlibmicroemu_1_1_machine.html">libmicroemu::Machine</a></div><div class="ttdoc">Represents the main emulation machine for handling microcontroller emulation.</div><div class="ttdef"><b>Definition</b> machine.h:54</div></div>
<div class="ttc" id="aclasslibmicroemu_1_1_machine_html_a41d9ccc5599dde9f3f214135a66aae9b"><div class="ttname"><a href="classlibmicroemu_1_1_machine.html#a41d9ccc5599dde9f3f214135a66aae9b">libmicroemu::Machine::GetVersion</a></div><div class="ttdeci">std::string_view GetVersion() noexcept</div><div class="ttdoc">Gets the version of the library.</div><div class="ttdef"><b>Definition</b> machine.cpp:146</div></div>
<div class="ttc" id="aclasslibmicroemu_1_1_machine_html_a7f302218280c95778710a790296b9514"><div class="ttname"><a href="classlibmicroemu_1_1_machine.html#a7f302218280c95778710a790296b9514">libmicroemu::Machine::Exec</a></div><div class="ttdeci">ExecResult Exec(i64 max_instructions=-1, FPreExecStepCallback cb_pre_exec=nullptr, FPostExecStepCallback cb_post_exec=nullptr) noexcept</div><div class="ttdoc">Executes the loaded program.</div><div class="ttdef"><b>Definition</b> machine.cpp:123</div></div>
<div class="ttc" id="aclasslibmicroemu_1_1_machine_html_ad21e56744fbf8b9e17f84fc8c176341a"><div class="ttname"><a href="classlibmicroemu_1_1_machine.html#ad21e56744fbf8b9e17f84fc8c176341a">libmicroemu::Machine::SetRam1Segment</a></div><div class="ttdeci">void SetRam1Segment(u8 *seg_ptr, me_size_t seg_size, me_adr_t seg_vadr) noexcept</div><div class="ttdoc">Sets the RAM1 segment The RAM1 segment is where a microcontroller stores its data....</div><div class="ttdef"><b>Definition</b> machine.cpp:101</div></div>
<div class="ttc" id="aclasslibmicroemu_1_1_machine_html_ae157cfa801f766a3641e02ad801e6aeb"><div class="ttname"><a href="classlibmicroemu_1_1_machine.html#ae157cfa801f766a3641e02ad801e6aeb">libmicroemu::Machine::SetFlashSegment</a></div><div class="ttdeci">void SetFlashSegment(u8 *seg_ptr, me_size_t seg_size, me_adr_t seg_vadr) noexcept</div><div class="ttdoc">Sets the Flash segment The flash segment is where a microcontroller stores its program code....</div><div class="ttdef"><b>Definition</b> machine.cpp:95</div></div>
<div class="ttc" id="aclasslibmicroemu_1_1_machine_html_af2b65fd6dcefc96f69974afb3b4ee66e"><div class="ttname"><a href="classlibmicroemu_1_1_machine.html#af2b65fd6dcefc96f69974afb3b4ee66e">libmicroemu::Machine::Load</a></div><div class="ttdeci">StatusCode Load(const char *elf_file, bool set_entry_point=false) noexcept</div><div class="ttdoc">Loads an ELF file into memory and optionally sets the entry point.</div><div class="ttdef"><b>Definition</b> machine.cpp:27</div></div>
<div class="ttc" id="amachine_8h_html"><div class="ttname"><a href="machine_8h.html">machine.h</a></div><div class="ttdoc">Contains the Machine class which is the main emulation machine for handling microcontroller emulation...</div></div>
<div class="ttc" id="anamespacelibmicroemu_html_a8986ac92210d741de2fbcbaf489c0ee0a8c632159fa131f09d04f94e3cbcd8782"><div class="ttname"><a href="namespacelibmicroemu.html#a8986ac92210d741de2fbcbaf489c0ee0a8c632159fa131f09d04f94e3cbcd8782">libmicroemu::StatusCode::kSuccess</a></div><div class="ttdeci">@ kSuccess</div><div class="ttdoc">Operation succeeded successfully.</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md10"></a>
Embedding Considerations</h2>
<ul>
<li><b>CMake Integration</b>: You can include <em>libmicroemu</em> directly in your project by adding it as a CMake subdirectory: <div class="fragment"><div class="line">add_subdirectory(path/to/libmicroemu)</div>
<div class="line">target_link_libraries(your_project PRIVATE libmicroemu)</div>
</div><!-- fragment --></li>
<li><b>Precompiled Libraries</b>: For convenience, precompiled versions of <em>libmicroemu</em> are available. These can be linked to your project to save build time and simplify integration.</li>
<li><b>Memory Configuration</b>: Ensure you allocate and set up code and RAM segments properly to emulate the ARM memory layout accurately.</li>
<li><b>Integration Points</b>: <em>libmicroemu</em> can be seamlessly embedded into any C++ project, supporting both development testing and deployment phases.</li>
<li><b>Custom Enhancements</b>: Depending on your application, you can extend memory configurations, include peripheral simulation, or adapt the emulator for specific use cases.</li>
</ul>
<h1><a class="anchor" id="autotoc_md11"></a>
Performance Results</h1>
<p>The CoreMark benchmark for a 2K performance run yielded <b>162.73 CoreMarks</b> on the emulator (detailed report follows), roughly equivalent to a Cortex-M4 at 50 MHz. This baseline result was measured on a MacBook Air with an M1 processor. Currently, the focus is on completing ARMv7-M support, with performance optimizations planned for future updates.</p>
<p><b>Background</b>: CoreMark is a widely recognized benchmark used to assess the performance of microcontrollers and processors. For comparison, a typical ARM Cortex-M4 running at 100 MHz might score between 250 to 350 CoreMarks, assuming linear scaling with clock speed.</p>
<div class="fragment"><div class="line">2K performance run parameters for coremark.</div>
<div class="line">CoreMark Size    : 666</div>
<div class="line">Total ticks      : 2458</div>
<div class="line">Total time (secs): 24.580000</div>
<div class="line">Iterations/Sec   : 162.733930</div>
<div class="line">Iterations       : 4000</div>
<div class="line">Compiler version : GCC10.3.1 20210824 (release)</div>
<div class="line">Compiler flags   : -g</div>
<div class="line">Memory location  : STACK</div>
<div class="line">seedcrc          : 0xe9f5</div>
<div class="line">[0]crclist       : 0xe714</div>
<div class="line">[0]crcmatrix     : 0x1fd7</div>
<div class="line">[0]crcstate      : 0x8e3a</div>
<div class="line">[0]crcfinal      : 0x65c5</div>
<div class="line">Correct operation validated. See README.md for run and reporting rules.</div>
<div class="line">CoreMark 1.0 : 162.733930 / GCC10.3.1 20210824 (release) -g / STACK</div>
</div><!-- fragment --> <h1><a class="anchor" id="autotoc_md12"></a>
Documentation</h1>
<p><a href="https://chgroeling.github.io/libmicroemu">Latest build - Doxygen documentation</a></p>
<h1><a class="anchor" id="autotoc_md13"></a>
Contributing</h1>
<p>Contributions are welcome! Please follow the Google C++ Style Guide, and ensure all new code includes documentation and test cases.</p>
<ol type="1">
<li>Fork the repository.</li>
<li>Create a feature branch.</li>
<li>Commit your changes.</li>
<li>Open a pull request.</li>
</ol>
<h1><a class="anchor" id="autotoc_md14"></a>
License</h1>
<p>This project is licensed under the MIT License. </p>
</div></div><!-- PageDoc -->
<a href="doxygen_crawl.html"></a>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
